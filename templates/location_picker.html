<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farm Location Picker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #map {
            height: 400px;
            width: 100%;
            margin-top: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .location-info {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        .saved-location {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .saved-location:hover {
            background-color: #e9ecef;
        }
        .map-error {
            height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #f8d7da;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            color: #721c24;
        }
        #cleanup-btn {
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <h1 class="text-center mb-4">Farm Location Picker</h1>
        
        <div class="card shadow">
            <div class="card-body">
                <div class="mb-3">
                    <label for="location-search" class="form-label">Search for your farm location:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="location-search" placeholder="Enter address or place name">
                        <button class="btn btn-outline-secondary" type="button" id="use-current-location">
                            <i class="bi bi-geo-alt"></i> Use Current Location
                        </button>
                    </div>
                </div>
                
                <div id="map-container">
                    <div id="map"></div>
                </div>
                
                <div class="location-info" id="location-info" style="display: none;">
                    <h4>Selected Location</h4>
                    <p><strong>Address:</strong> <span id="location-address"></span></p>
                    <p><strong>Coordinates:</strong> <span id="location-coords"></span></p>
                    <button class="btn btn-primary" id="save-location">
                        <i class="bi bi-save"></i> Save This Location
                    </button>
                    <button id="cleanup-btn" class="btn btn-warning mt-2">
                        <i class="bi bi-trash"></i> Clean Invalid Entries
                    </button>
                </div>
                
                <div class="mt-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>Saved Locations</h4>
                        <button class="btn btn-sm btn-outline-danger" id="clear-locations">
                            <i class="bi bi-trash"></i> Clear All
                        </button>
                    </div>
                    <div id="saved-locations" class="list-group">
                        <div class="list-group-item text-center text-muted">
                            No locations saved yet
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let map;
        let marker;
        let selectedLocation = null;
        let geocoder;
        
        function showMapError() {
            const mapContainer = document.getElementById("map-container");
            mapContainer.innerHTML = `
                <div class="map-error">
                    <h4><i class="bi bi-exclamation-triangle-fill"></i> Map Loading Failed</h4>
                    <p>Please check your internet connection and try again.</p>
                    <button onclick="retryMapLoad()" class="btn btn-warning mt-3">
                        <i class="bi bi-arrow-clockwise"></i> Retry
                    </button>
                </div>
            `;
        }
        
        function retryMapLoad() {
            document.getElementById("map-container").innerHTML = '<div id="map"></div>';
            initializeMap();
        }
        
        function initializeMap() {
            if (window.google && window.google.maps) {
                initMap();
            } else {
                loadGoogleMapsAPI();
            }
        }
        
        function loadGoogleMapsAPI() {
            const script = document.createElement("script");
            script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyDqgRQe8nu1lJry7NI0MgF21WSdRSOLEmw&libraries=places&callback=initMap`;
            script.async = true;
            script.defer = true;
            script.onerror = showMapError;
            document.head.appendChild(script);
        }
        
        function initMap() {
            try {
                const indiaCenter = { lat: 20.5937, lng: 78.9629 };
                map = new google.maps.Map(document.getElementById("map"), {
                    center: indiaCenter,
                    zoom: 5,
                });
                
                geocoder = new google.maps.Geocoder();
                setupSearchBox();
                
                map.addListener("click", (e) => {
                    setLocationFromLatLng(e.latLng);
                });
                
                document.getElementById("use-current-location").addEventListener("click", getCurrentLocation);
                
            } catch (error) {
                console.error("Map initialization error:", error);
                showMapError();
            }
        }
        
        function setupSearchBox() {
            const input = document.getElementById("location-search");
            const searchBox = new google.maps.places.SearchBox(input);
            
            map.addListener("bounds_changed", () => {
                searchBox.setBounds(map.getBounds());
            });
            
            searchBox.addListener("places_changed", () => {
                const places = searchBox.getPlaces();
                if (places.length === 0) return;
                
                const place = places[0];
                if (!place.geometry) return;
                
                if (marker) marker.setMap(null);
                
                selectedLocation = {
                    address: place.formatted_address || "Unnamed location",
                    coordinates: {
                        lat: place.geometry.location.lat(),
                        lng: place.geometry.location.lng()
                    }
                };
                
                updateLocationInfo();
                map.setCenter(place.geometry.location);
                map.setZoom(15);
                
                marker = new google.maps.Marker({
                    map,
                    position: place.geometry.location,
                    title: place.name || "Selected location"
                });
            });
        }
        
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        setLocationFromLatLng(pos);
                    },
                    (error) => {
                        alert("Error getting location: " + error.message);
                    },
                    { timeout: 10000 } // 10 second timeout
                );
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }
        
        function setLocationFromLatLng(latLng) {
            if (marker) marker.setMap(null);
            
            marker = new google.maps.Marker({
                position: latLng,
                map: map,
                title: "Selected location"
            });
            
            geocoder.geocode({ location: latLng }, (results, status) => {
                selectedLocation = {
                    address: (status === "OK" && results[0]) 
                        ? results[0].formatted_address 
                        : "Unnamed location",
                    coordinates: {
                        lat: latLng.lat(),
                        lng: latLng.lng()
                    }
                };
                updateLocationInfo();
            });
            
            map.setCenter(latLng);
            map.setZoom(15);
        }
        
        function updateLocationInfo() {
            if (!selectedLocation || !selectedLocation.coordinates) return;
            
            document.getElementById("location-info").style.display = "block";
            document.getElementById("location-address").textContent = selectedLocation.address;
            document.getElementById("location-coords").textContent = 
                `${selectedLocation.coordinates.lat.toFixed(6)}, ${selectedLocation.coordinates.lng.toFixed(6)}`;
        }
        
        function loadSavedLocations() {
            fetch("/api/get-locations")
                .then(response => {
                    if (!response.ok) throw new Error("Network error");
                    return response.json();
                })
                .then(data => {
                    const container = document.getElementById("saved-locations");
                    container.innerHTML = "";
                    
                    // Filter out invalid entries
                    const validLocations = (data.locations || []).filter(loc => 
                        loc.location?.coordinates
                    );
                    
                    if (validLocations.length === 0) {
                        container.innerHTML = '<div class="list-group-item text-center text-muted">No valid locations saved</div>';
                        return;
                    }
                    
                    validLocations.forEach((loc, index) => {
                        const locationData = loc.location;
                        const item = document.createElement("div");
                        item.className = "list-group-item saved-location";
                        
                        item.innerHTML = `
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">Location #${index + 1}</h5>
                                <small>${new Date(loc.timestamp).toLocaleString()}</small>
                            </div>
                            <p class="mb-1">${locationData.address || "No address"}</p>
                            <small>Coordinates: ${locationData.coordinates.lat.toFixed(6)}, ${locationData.coordinates.lng.toFixed(6)}</small>
                        `;
                        
                        item.addEventListener("click", () => {
                            if (map && locationData.coordinates) {
                                const latLng = new google.maps.LatLng(
                                    locationData.coordinates.lat,
                                    locationData.coordinates.lng
                                );
                                setLocationFromLatLng(latLng);
                            }
                        });
                        
                        container.appendChild(item);
                    });
                })
                .catch(error => {
                    console.error("Error loading locations:", error);
                    document.getElementById("saved-locations").innerHTML = 
                        '<div class="list-group-item text-center text-danger">Error loading locations</div>';
                });
        }
        
        function saveLocation() {
            if (!selectedLocation?.coordinates) {
                alert("Please select a valid location first");
                return;
            }
            
            const locationData = {
                ip: "127.0.0.1", // Should be replaced with actual IP from backend
                timestamp: new Date().toISOString(),
                location: {
                    address: selectedLocation.address || "Unnamed location",
                    coordinates: selectedLocation.coordinates
                }
            };
            
            fetch("/api/process-location", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(locationData)
            })
            .then(response => {
                if (!response.ok) throw new Error("Server error");
                return response.json();
            })
            .then(data => {
                if (data.error) throw new Error(data.error);
                alert("Location saved successfully!");
                loadSavedLocations();
            })
            .catch(error => {
                console.error("Save error:", error);
                alert("Failed to save: " + error.message);
            });
        }
        
        function cleanInvalidEntries() {
            if (!confirm("This will permanently remove all invalid location entries. Continue?")) return;
            
            fetch("/api/get-locations")
                .then(response => {
                    if (!response.ok) throw new Error("Network error");
                    return response.json();
                })
                .then(data => {
                    // Filter out invalid entries
                    const cleanData = (data.locations || []).filter(loc => 
                        loc.location?.coordinates
                    );
                    
                    return fetch("/api/replace-locations", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ locations: cleanData })
                    });
                })
                .then(response => {
                    if (!response.ok) throw new Error("Cleanup failed");
                    return response.json();
                })
                .then(data => {
                    if (data.error) throw new Error(data.error);
                    alert("Cleaned up invalid entries!");
                    loadSavedLocations();
                })
                .catch(error => {
                    console.error("Cleanup error:", error);
                    alert("Cleanup failed: " + error.message);
                });
        }
        
        function clearLocations() {
            if (confirm("Are you sure you want to delete ALL saved locations?")) {
                fetch("/api/clear-locations", {
                    method: "POST"
                })
                .then(response => {
                    if (!response.ok) throw new Error("Clear failed");
                    return response.json();
                })
                .then(data => {
                    if (data.error) throw new Error(data.error);
                    alert("All locations cleared");
                    loadSavedLocations();
                })
                .catch(error => {
                    console.error("Clear error:", error);
                    alert("Clear failed: " + error.message);
                });
            }
        }
        
        // Initialize the page
        document.addEventListener("DOMContentLoaded", function() {
            initializeMap();
            document.getElementById("save-location").addEventListener("click", saveLocation);
            document.getElementById("clear-locations").addEventListener("click", clearLocations);
            document.getElementById("cleanup-btn").addEventListener("click", cleanInvalidEntries);
            loadSavedLocations();
        });
    </script>
</body>
</html>